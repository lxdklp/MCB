name: Flutter 构建

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_release:
        description: '不创建 Release'
        required: false
        default: true
        type: boolean

env:
    FLUTTER_VERSION: '3.38.3'

jobs:
    build-android:
        name: 构建 Android
        runs-on: ubuntu-latest
        steps:
            - name: 签出代码
              uses: actions/checkout@v4
            - name: 配置 Java
              uses: actions/setup-java@v4
              with:
                distribution: 'zulu'
                java-version: '17'
            - name: 配置 Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true
            - name: 安装依赖
              run: flutter pub get
            - name: 解码密钥库
              if: github.event_name != 'pull_request'
              env:
                KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
              run: |
                mkdir -p android/app
                echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
                chmod 600 android/app/upload-keystore.jks
            - name: 写入密钥库
              if: github.event_name != 'pull_request'
              env:
                KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
                KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
              run: |
                cat > android/key.properties <<EOF
                storePassword=$KEYSTORE_PASSWORD
                keyPassword=$KEY_PASSWORD
                keyAlias=$KEY_ALIAS
                storeFile=upload-keystore.jks
                EOF
            - name: 构建 Android 安装包
              run: flutter build apk --release --split-per-abi
            - name: 准备 Android 构建产物
              id: prepare_android
              run: |
                set -e
                # extract version from pubspec.yaml (strip +build metadata)
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                mkdir -p artifacts/android-release
                APK_DIR=build/app/outputs/flutter-apk
                if [ -f "$APK_DIR/app-arm64-v8a-release.apk" ]; then
                  cp "$APK_DIR/app-arm64-v8a-release.apk" "artifacts/MCB-Android-${VERSION}-arm64-v8a.apk"
                fi
                if [ -f "$APK_DIR/app-armeabi-v7a-release.apk" ]; then
                  cp "$APK_DIR/app-armeabi-v7a-release.apk" "artifacts/MCB-Android-${VERSION}-armeabi-v7a.apk"
                fi
                if [ -f "$APK_DIR/app-x86_64-release.apk" ]; then
                  cp "$APK_DIR/app-x86_64-release.apk" "artifacts/MCB-Android-${VERSION}-x86_64.apk"
                fi
            - name: 上传 Android 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: android-release
                path: artifacts/MCB-Android-${{ steps.prepare_android.outputs.VERSION }}-*.apk
                retention-days: 7

    build-windows:
        name: 构建 Windows
        runs-on: windows-latest
        steps:
            - name: 签出代码
              uses: actions/checkout@v4
            - name: 配置 Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true
            - name: 安装依赖
              run: flutter pub get
            - name: 构建 Windows 版本
              run: flutter build windows --release
            - name: 打包 Windows 构建产物
              shell: pwsh
              run: |
                $VERSION = (Select-String -Path pubspec.yaml -Pattern '^version:' | ForEach-Object { $_.Line -replace 'version:\s*', '' -replace '\+.*', '' }).Trim()
                Write-Host "VERSION=$VERSION"
                # 创建 zip 包
                Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath "MCB-Windows-$VERSION-x64.zip"
            - name: 使用 Inno Setup 创建 Windows 安装程序
              shell: pwsh
              run: |
                $VERSION = (Select-String -Path pubspec.yaml -Pattern '^version:' | ForEach-Object { $_.Line -replace 'version:\s*', '' -replace '\+.*', '' }).Trim()
                Write-Host "VERSION=$VERSION"
                # 通过 Chocolatey 安装 Inno Setup
                Write-Host "Installing Inno Setup via Chocolatey..."
                choco install innosetup -y --no-progress
                Write-Host "Inno Setup installed"
                # 定位 ISCC.exe
                $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
                if (-not (Test-Path $isccPath)) {
                  Write-Host "ISCC not at default path, searching..."
                  $found = Get-ChildItem -Path "C:\Program Files (x86)" -Recurse -Filter "ISCC.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
                  if ($found) { $isccPath = $found.FullName }
                }
                if (-not (Test-Path $isccPath)) {
                  throw "ISCC.exe not found after Chocolatey install"
                }
                Write-Host "Found ISCC at: $isccPath"
                # 创建 Inno Setup 脚本
                $issContent = "[Setup]`n"
                $issContent += "AppName=MCB`n"
                $issContent += "AppVersion=$VERSION`n"
                $issContent += "DefaultDirName={autopf}\MCB`n"
                $issContent += "DefaultGroupName=MCB`n"
                $issContent += "OutputDir=.`n"
                $issContent += "OutputBaseFilename=MCB-Windows-$VERSION-x64-setup`n"
                $issContent += "Compression=lzma2`n"
                $issContent += "SolidCompression=yes`n"
                $issContent += "ArchitecturesAllowed=x64compatible`n"
                $issContent += "ArchitecturesInstallIn64BitMode=x64compatible`n"
                $issContent += "`n"
                $issContent += "[Files]`n"
                $issContent += "Source: `"build\windows\x64\runner\Release\*`"; DestDir: `"{app}`"; Flags: ignoreversion recursesubdirs`n"
                $issContent += "`n"
                $issContent += "[Icons]`n"
                $issContent += "Name: `"{group}\MCB`"; Filename: `"{app}\mcb.exe`"`n"
                $issContent += "Name: `"{commondesktop}\MCB`"; Filename: `"{app}\mcb.exe`"`n"
                $issContent += "`n"
                $issContent += "[Run]`n"
                $issContent += "Filename: `"{app}\mcb.exe`"; Description: `"Launch MCB`"; Flags: nowait postinstall skipifsilent`n"
                $issContent | Out-File -FilePath "setup.iss" -Encoding UTF8 -NoNewline
                Write-Host "创建 setup.iss"
                # 运行 ISCC.exe 创建安装程序
                Write-Host "运行 ISCC.exe 创建安装程序..."
                & "$isccPath" "setup.iss"
                if ($LASTEXITCODE -ne 0) {
                  throw "ISCC.exe failed with exit code $LASTEXITCODE"
                }
                Write-Host "安装程序创建成功"
            - name: 上传 Windows 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: windows-release
                path: |
                  MCB-Windows-*-x64.zip
                  MCB-Windows-*-x64-installer.exe
                retention-days: 7

    build-linux-x64:
        name: 构建 Linux (x64)
        runs-on: ubuntu-latest
        steps:
            - name: 签出代码
              uses: actions/checkout@v4
            - name: 配置 Linux (x64)
              run: |
                sudo apt-get update
                sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
            - name: 配置 Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true
            - name: 安装依赖
              run: flutter pub get
            - name: 构建 Linux (x64) 版本
              run: flutter build linux --release
            - name: 安装打包工具
              run: |
                sudo apt-get update
                sudo apt-get install -y libfuse2 zip
            - name: 打包 Linux (x64) 构建产物
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                BUNDLE_DIR=build/linux/x64/release/bundle
                # 在工作区根目录创建 zip
                cd $BUNDLE_DIR && zip -r "$GITHUB_WORKSPACE/MCB-Linux-${VERSION}-x64.zip" . && cd "$GITHUB_WORKSPACE"
                # 创建 .deb 包
                mkdir -p deb_pkg/DEBIAN
                mkdir -p deb_pkg/usr/bin
                mkdir -p deb_pkg/usr/share/applications
                mkdir -p deb_pkg/usr/share/mcb
                cp -r $BUNDLE_DIR/* deb_pkg/usr/share/mcb/
                printf 'Package: mcb\nVersion: %s\nSection: utils\nPriority: optional\nArchitecture: amd64\nMaintainer: lxdklp\nDescription: MCB Application\n' "$VERSION" > deb_pkg/DEBIAN/control
                printf '#!/bin/bash\nexec /usr/share/mcb/mcb "$@"\n' > deb_pkg/usr/bin/mcb
                chmod +x deb_pkg/usr/bin/mcb
                printf '[Desktop Entry]\nName=MCB\nExec=/usr/share/mcb/mcb\nType=Application\nCategories=Utility;\n' > deb_pkg/usr/share/applications/mcb.desktop
                dpkg-deb --build deb_pkg MCB-Linux-${VERSION}-x64.deb
                # 创建 AppImage
                mkdir -p AppDir/usr/bin
                mkdir -p AppDir/usr/share/applications
                mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
                cp -r $BUNDLE_DIR/* AppDir/usr/bin/
                # Copy icon to AppDir root (required by appimagetool)
                if [ -f "assets/img/icon/icon.png" ]; then
                  cp assets/img/icon/icon.png AppDir/mcb.png
                else
                  touch AppDir/mcb.png
                fi
                cp AppDir/mcb.png AppDir/usr/share/icons/hicolor/256x256/apps/mcb.png
                printf '[Desktop Entry]\nName=MCB\nExec=mcb\nIcon=mcb\nType=Application\nCategories=Utility;\n' > AppDir/mcb.desktop
                cp AppDir/mcb.desktop AppDir/usr/share/applications/
                printf '#!/bin/bash\nexec $APPDIR/usr/bin/mcb "$@"\n' > AppDir/AppRun
                chmod +x AppDir/AppRun
                curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
                chmod +x appimagetool
                ARCH=x86_64 ./appimagetool --appimage-extract-and-run AppDir MCB-Linux-${VERSION}-x64.AppImage
            - name: 上传 Linux (x64) 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: linux-x64-release
                path: |
                  MCB-Linux-*-x64.zip
                  MCB-Linux-*-x64.deb
                  MCB-Linux-*-x64.AppImage
                retention-days: 7

    build-linux-arm64:
        name: 构建 Linux (arm64)
        runs-on: ubuntu-24.04-arm
        steps:
            - name: 签出代码
              uses: actions/checkout@v4
            - name: 配置 Linux (arm64)
              run: |
                sudo apt-get update
                sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libfuse2
            - name: 配置 Flutter
              run: |
                set -e
                echo "Cloning Flutter stable channel into $HOME/flutter"
                git clone https://github.com/flutter/flutter.git -b stable --depth 1 $HOME/flutter
                echo "$HOME/flutter/bin" >> $GITHUB_PATH
                export PATH="$HOME/flutter/bin:$PATH"
                flutter --version
                flutter precache --linux
            - name: 安装依赖
              run: flutter pub get
            - name: 构建 Linux (arm64) 版本
              run: flutter build linux --release
            - name: 安装打包工具
              run: |
                sudo apt-get update
                sudo apt-get install -y libfuse2 zip
            - name: 打包 Linux (arm64) 构建产物
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                BUNDLE_DIR=build/linux/arm64/release/bundle
                # 在工作区根目录创建 zip
                cd $BUNDLE_DIR && zip -r "$GITHUB_WORKSPACE/MCB-Linux-${VERSION}-arm64.zip" . && cd "$GITHUB_WORKSPACE"
                # 创建 .deb 包
                mkdir -p deb_pkg/DEBIAN
                mkdir -p deb_pkg/usr/bin
                mkdir -p deb_pkg/usr/share/applications
                mkdir -p deb_pkg/usr/share/mcb
                cp -r $BUNDLE_DIR/* deb_pkg/usr/share/mcb/
                printf 'Package: mcb\nVersion: %s\nSection: utils\nPriority: optional\nArchitecture: arm64\nMaintainer: lxdklp\nDescription: MCB Application\n' "$VERSION" > deb_pkg/DEBIAN/control
                printf '#!/bin/bash\nexec /usr/share/mcb/mcb "$@"\n' > deb_pkg/usr/bin/mcb
                chmod +x deb_pkg/usr/bin/mcb
                printf '[Desktop Entry]\nName=MCB\nExec=/usr/share/mcb/mcb\nType=Application\nCategories=Utility;\n' > deb_pkg/usr/share/applications/mcb.desktop
                dpkg-deb --build deb_pkg MCB-Linux-${VERSION}-arm64.deb
                # 创建 AppImage
                mkdir -p AppDir/usr/bin
                mkdir -p AppDir/usr/share/applications
                mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
                cp -r $BUNDLE_DIR/* AppDir/usr/bin/
                # Copy icon to AppDir root (required by appimagetool)
                if [ -f "assets/img/icon/icon.png" ]; then
                  cp assets/img/icon/icon.png AppDir/mcb.png
                else
                  touch AppDir/mcb.png
                fi
                cp AppDir/mcb.png AppDir/usr/share/icons/hicolor/256x256/apps/mcb.png
                printf '[Desktop Entry]\nName=MCB\nExec=mcb\nIcon=mcb\nType=Application\nCategories=Utility;\n' > AppDir/mcb.desktop
                cp AppDir/mcb.desktop AppDir/usr/share/applications/
                printf '#!/bin/bash\nexec $APPDIR/usr/bin/mcb "$@"\n' > AppDir/AppRun
                chmod +x AppDir/AppRun
                curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
                chmod +x appimagetool
                ARCH=aarch64 ./appimagetool --appimage-extract-and-run AppDir MCB-Linux-${VERSION}-arm64.AppImage
            - name: 上传 Linux (arm64) 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: linux-arm64-release
                path: |
                  MCB-Linux-*-arm64.zip
                  MCB-Linux-*-arm64.deb
                  MCB-Linux-*-arm64.AppImage
                retention-days: 7

    build-macos:
        name: 构建 macOS
        runs-on: macos-latest
        steps:
            - name: 签出代码
              uses: actions/checkout@v4

            - name: 配置 Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true
            - name: 安装依赖
              run: flutter pub get
            - name: 构建 macOS 版本
              run: flutter build macos --release
            - name: 创建 dmg 镜像
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                RELEASE_DIR="build/macos/Build/Products/Release"
                echo "Looking for .app in: $RELEASE_DIR"
                echo "Release dir contents:"
                ls -la "$RELEASE_DIR" || true
                # 查找 .app 包
                APP_DIR=$(find "$RELEASE_DIR" -maxdepth 1 -name "*.app" -type d | head -n1)
                if [ -z "$APP_DIR" ]; then
                  echo "No .app found via find. Trying known paths..."
                  if [ -d "$RELEASE_DIR/Runner.app" ]; then
                    APP_DIR="$RELEASE_DIR/Runner.app"
                  elif [ -d "$RELEASE_DIR/mcb.app" ]; then
                    APP_DIR="$RELEASE_DIR/mcb.app"
                  elif [ -d "$RELEASE_DIR/MCB.app" ]; then
                    APP_DIR="$RELEASE_DIR/MCB.app"
                  else
                    echo "Unable to find .app to package. Failing step." >&2
                    exit 1
                  fi
                fi
                echo "Found app bundle: $APP_DIR"
                APP_NAME=$(basename "$APP_DIR" .app)
                OUT_NAME="MCB-macOS-${VERSION}.dmg"
                echo "Creating DMG: $OUT_NAME"
                # 创建一个暂存文件夹
                DMG_STAGE="dmg_stage"
                mkdir -p "$DMG_STAGE"
                cp -R "$APP_DIR" "$DMG_STAGE/"
                ln -s /Applications "$DMG_STAGE/Applications"
                echo "DMG stage contents:"
                ls -la "$DMG_STAGE"
                hdiutil create -volname "$APP_NAME" -srcfolder "$DMG_STAGE" -ov -format UDZO "$OUT_NAME"
                rm -rf "$DMG_STAGE"
            - name: 上传 macOS 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: macos-release
                path: MCB-macOS-*.dmg
                retention-days: 7

    build-web:
        name: 构建 Web
        runs-on: ubuntu-latest
        steps:
            - name: 签出代码
              uses: actions/checkout@v4
            - name: 配置 Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true
            - name: 安装依赖
              run: flutter pub get
            - name: 构建 Web 版本
              run: flutter build web --release
            - name: 打包 Web 构建产物
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                cd build/web
                zip -r ../../MCB-Web-${VERSION}.zip .
            - name: 上传 Web 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: web-release
                path: MCB-Web-*.zip
                retention-days: 7

    build-ios:
        name: 构建 iOS
        runs-on: macos-latest
        steps:
            - name: 签出代码
              uses: actions/checkout@v4
            - name: 配置 Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true
            - name: 安装依赖
              run: flutter pub get
            - name: 构建 iOS 版本
              run: flutter build ios --release --no-codesign
            - name: 打包 iOS 构建产物
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                # 创建 Payload 目录结构以生成 .ipa
                mkdir -p Payload
                cp -r build/ios/iphoneos/Runner.app Payload/
                zip -r "MCB-iOS-${VERSION}.ipa" Payload
                rm -rf Payload
            - name: 上传 iOS 构建产物
              uses: actions/upload-artifact@v4
              with:
                name: ios-release
                path: MCB-iOS-*.ipa
                retention-days: 7

    release:
      name: 创建发布
      needs: [build-android, build-windows, build-linux-x64, build-linux-arm64, build-macos, build-web, build-ios]
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.skip_release != 'true'
      permissions:
        contents: write
      steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                path: artifacts
            - name: 收集 Android APK
              run: |
                set -e
                mkdir -p artifacts/android-release
                # 移动所有 APK 文件到统一目录
                cp artifacts/MCB-Android-*.apk artifacts/android-release/ 2>/dev/null || true
            - name: 创建发布
              uses: softprops/action-gh-release@v1
              with:
                files: |
                  artifacts/android-release/*.apk
                  artifacts/ios-release/*.ipa
                  artifacts/windows-release/*.zip
                  artifacts/windows-release/*.exe
                  artifacts/linux-x64-release/*.zip
                  artifacts/linux-x64-release/*.deb
                  artifacts/linux-x64-release/*.AppImage
                  artifacts/linux-arm64-release/*.zip
                  artifacts/linux-arm64-release/*.deb
                  artifacts/linux-arm64-release/*.AppImage
                  artifacts/macos-release/*.dmg
                  artifacts/web-release/*.zip
                draft: false
                prerelease: false
                generate_release_notes: true
