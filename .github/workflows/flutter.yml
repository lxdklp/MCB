name: Flutter Build

on:
    push:
        branches: [main, master]
        tags:
            - 'v*'
    pull_request:
        branches: [main, master]
    workflow_dispatch:
        inputs:
            skip_release:
                description: '不创建 Release'
                required: false
                default: false
                type: boolean

env:
    FLUTTER_VERSION: '3.38.3'

jobs:
    build-android:
        name: Build Android
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                distribution: 'zulu'
                java-version: '17'

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get
            - name: Decode keystore (only on trusted events)
              if: github.event_name != 'pull_request'
              env:
                KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
              run: |
                mkdir -p android/app
                echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
                chmod 600 android/app/upload-keystore.jks

            - name: Write key.properties (only on trusted events)
              if: github.event_name != 'pull_request'
              env:
                KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
                KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
              run: |
                cat > android/key.properties <<EOF
                storePassword=$KEYSTORE_PASSWORD
                keyPassword=$KEY_PASSWORD
                keyAlias=$KEY_ALIAS
                storeFile=upload-keystore.jks
                EOF

            - name: Build Android APK (split per abi)
              run: flutter build apk --release --split-per-abi

            - name: Upload Android artifact
              uses: actions/upload-artifact@v4
              with:
                name: android-release
                path: build/app/outputs/flutter-apk/*.apk
                retention-days: 7

            - name: Cleanup keystore (only on trusted events)
              if: github.event_name != 'pull_request'
              run: |
                shred -u android/app/upload-keystore.jks || rm -f android/app/upload-keystore.jks
                rm -f android/key.properties

    build-ios:
        name: Build iOS
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build iOS (no codesign)
              run: flutter build ios --release --no-codesign

            - name: Zip iOS build
              run: |
                cd build/ios/iphoneos
                zip -r ../../../ios-release.zip Runner.app

            - name: Upload iOS artifact
              uses: actions/upload-artifact@v4
              with:
                name: ios-release
                path: ios-release.zip
                retention-days: 7

    build-windows:
        name: Build Windows
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Windows
              run: flutter build windows --release

            - name: Upload Windows artifact
              uses: actions/upload-artifact@v4
              with:
                name: windows-release
                path: build/windows/x64/runner/Release/
                retention-days: 7

    build-linux:
        name: Build Linux
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Linux dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Linux
              run: flutter build linux --release

            - name: Upload Linux artifact
              uses: actions/upload-artifact@v4
              with:
                name: linux-release
                path: build/linux/x64/release/bundle/
                retention-days: 7

    build-macos:
        name: Build macOS
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build macOS
              run: flutter build macos --release

            - name: Upload macOS artifact
              uses: actions/upload-artifact@v4
              with:
                name: macos-release
                path: build/macos/Build/Products/Release/*.app
                retention-days: 7

    build-web:
        name: Build Web
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Web
              run: flutter build web --release

            - name: Upload Web artifact
              uses: actions/upload-artifact@v4
              with:
                name: web-release
                path: build/web/
                retention-days: 7

    release:
        name: Create Release
        needs: [build-android, build-ios, build-windows, build-linux, build-macos, build-web]
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.skip_release != 'true'
        permissions:
            contents: write
        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                path: artifacts

            - name: Zip Android releases
              run: |
                cd artifacts/android-release
                zip -r ../../MCB-android-apks.zip .

            - name: Prepare iOS release
              run: |
                mv artifacts/ios-release/ios-release.zip MCB-ios.zip

            - name: Zip Windows release
              run: |
                cd artifacts/windows-release
                zip -r ../../MCB-windows-x64.zip .

            - name: Zip Linux release
              run: |
                cd artifacts/linux-release
                tar -czvf ../../MCB-linux-x64.tar.gz .

            - name: Zip macOS release
              run: |
                cd artifacts/macos-release
                zip -r ../../MCB-macos-x64.zip .

            - name: Zip Web release
              run: |
                cd artifacts/web-release
                zip -r ../../MCB-web.zip .

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                files: |
                  MCB-android-apks.zip
                  MCB-ios.zip
                  MCB-windows-x64.zip
                  MCB-linux-x64.tar.gz
                  MCB-macos-x64.zip
                  MCB-web.zip
                draft: false
                prerelease: false
                generate_release_notes: true
