name: Flutter Build

on:
    push:
        branches: [main, master]
        tags:
            - 'v*'
    pull_request:
        branches: [main, master]
    workflow_dispatch:
        inputs:
            skip_release:
                description: '不创建 Release'
                required: false
                default: false
                type: boolean

env:
    FLUTTER_VERSION: '3.38.3'

jobs:
    build-android:
        name: Build Android
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                distribution: 'zulu'
                java-version: '17'

            - name: Install Flutter (ARM64)
              run: |
                set -e
                echo "Cloning Flutter stable channel into $HOME/flutter"
                git clone https://github.com/flutter/flutter.git -b stable --depth 1 $HOME/flutter
                echo "$HOME/flutter/bin" >> $GITHUB_PATH
                # ensure flutter is available in this step
                export PATH="$HOME/flutter/bin:$PATH"
                flutter --version
                # precache linux artifacts
                flutter precache --platforms=linux

            - name: Install dependencies
              run: flutter pub get
            - name: Decode keystore (only on trusted events)
              if: github.event_name != 'pull_request'
              env:
                KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
              run: |
                mkdir -p android/app
                echo "$KEYSTORE_BASE64" | base64 --decode > android/app/upload-keystore.jks
                chmod 600 android/app/upload-keystore.jks

            - name: Write key.properties (only on trusted events)
              if: github.event_name != 'pull_request'
              env:
                KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
                KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
                KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
              run: |
                cat > android/key.properties <<EOF
                storePassword=$KEYSTORE_PASSWORD
                keyPassword=$KEY_PASSWORD
                keyAlias=$KEY_ALIAS
                storeFile=upload-keystore.jks
                EOF

            - name: Build Android APK (split per abi)
              run: flutter build apk --release --split-per-abi

            - name: Prepare Android artifacts per ABI
              id: prepare_android
              run: |
                set -e
                # extract version from pubspec.yaml (strip +build metadata)
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
                mkdir -p artifacts/android-release
                APK_DIR=build/app/outputs/flutter-apk
                if [ -f "$APK_DIR/app-arm64-v8a-release.apk" ]; then
                  cp "$APK_DIR/app-arm64-v8a-release.apk" "artifacts/MCB-Android-${VERSION}-arm64-v8a.apk"
                fi
                if [ -f "$APK_DIR/app-armeabi-v7a-release.apk" ]; then
                  cp "$APK_DIR/app-armeabi-v7a-release.apk" "artifacts/MCB-Android-${VERSION}-armeabi-v7a.apk"
                fi
                if [ -f "$APK_DIR/app-x86_64-release.apk" ]; then
                  cp "$APK_DIR/app-x86_64-release.apk" "artifacts/MCB-Android-${VERSION}-x86_64.apk"
                fi

            - name: Upload Android APKs as artifacts
              uses: actions/upload-artifact@v4
              with:
                name: android-release
                path: artifacts/MCB-Android-${{ steps.prepare_android.outputs.VERSION }}-*.apk
                retention-days: 7

            - name: Install dependencies
              run: flutter pub get

    build-windows:
        name: Build Windows
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Windows
              run: flutter build windows --release

            - name: Package Windows artifacts
              shell: pwsh
              run: |
                $VERSION = (Select-String -Path pubspec.yaml -Pattern '^version:' | ForEach-Object { $_.Line -replace 'version:\s*', '' -replace '\+.*', '' }).Trim()
                Write-Host "VERSION=$VERSION"
                # Create zip
                Compress-Archive -Path build/windows/x64/runner/Release/* -DestinationPath "MCB-Windows-$VERSION-x64.zip"

            - name: Create Windows Installer (Inno Setup)
              shell: pwsh
              run: |
                $VERSION = (Select-String -Path pubspec.yaml -Pattern '^version:' | ForEach-Object { $_.Line -replace 'version:\s*', '' -replace '\+.*', '' }).Trim()
                # Download and install Inno Setup
                Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup.exe"
                Start-Process -Wait -FilePath "innosetup.exe" -ArgumentList "/VERYSILENT","/SUPPRESSMSGBOXES","/NORESTART","/SP-"
                # Create Inno Setup script
                $issContent = @"
                [Setup]
                AppName=MCB
                AppVersion=$VERSION
                DefaultDirName={autopf}\MCB
                DefaultGroupName=MCB
                OutputDir=.
                OutputBaseFilename=MCB-Windows-$VERSION-x64-setup
                Compression=lzma2
                SolidCompression=yes
                ArchitecturesAllowed=x64compatible
                ArchitecturesInstallIn64BitMode=x64compatible

                [Files]
                Source: "build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

                [Icons]
                Name: "{group}\MCB"; Filename: "{app}\mcb.exe"
                Name: "{commondesktop}\MCB"; Filename: "{app}\mcb.exe"

                [Run]
                Filename: "{app}\mcb.exe"; Description: "Launch MCB"; Flags: nowait postinstall skipifsilent
                "@
                $issContent | Out-File -FilePath "setup.iss" -Encoding UTF8
                & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "setup.iss"

            - name: Upload Windows artifacts
              uses: actions/upload-artifact@v4
              with:
                name: windows-release
                path: |
                  MCB-Windows-*-x64.zip
                  MCB-Windows-*-x64-setup.exe
                retention-days: 7

    build-linux-x64:
        name: Build Linux x64
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Linux dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Linux (x64)
              run: flutter build linux --release

            - name: Install packaging tools
              run: |
                sudo apt-get update
                sudo apt-get install -y libfuse2 zip

            - name: Package Linux x64 artifacts
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                BUNDLE_DIR=build/linux/x64/release/bundle
                # Create zip
                cd $BUNDLE_DIR && zip -r ../../../../MCB-Linux-${VERSION}-x64.zip . && cd -
                # Create .deb package
                mkdir -p deb_pkg/DEBIAN
                mkdir -p deb_pkg/usr/bin
                mkdir -p deb_pkg/usr/share/applications
                mkdir -p deb_pkg/usr/share/mcb
                cp -r $BUNDLE_DIR/* deb_pkg/usr/share/mcb/
                cat > deb_pkg/DEBIAN/control <<EOF
                Package: mcb
                Version: ${VERSION}
                Section: utils
                Priority: optional
                Architecture: amd64
                Maintainer: lxdklp
                Description: MCB Application
                EOF
                cat > deb_pkg/usr/bin/mcb <<EOF
                #!/bin/bash
                exec /usr/share/mcb/mcb "\$@"
                EOF
                chmod +x deb_pkg/usr/bin/mcb
                cat > deb_pkg/usr/share/applications/mcb.desktop <<EOF
                [Desktop Entry]
                Name=MCB
                Exec=/usr/share/mcb/mcb
                Type=Application
                Categories=Utility;
                EOF
                dpkg-deb --build deb_pkg MCB-Linux-${VERSION}-x64.deb
                # Create AppImage
                mkdir -p AppDir/usr/bin
                mkdir -p AppDir/usr/share/applications
                mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
                cp -r $BUNDLE_DIR/* AppDir/usr/bin/
                cat > AppDir/mcb.desktop <<EOF
                [Desktop Entry]
                Name=MCB
                Exec=mcb
                Icon=mcb
                Type=Application
                Categories=Utility;
                EOF
                cp AppDir/mcb.desktop AppDir/usr/share/applications/
                touch AppDir/usr/share/icons/hicolor/256x256/apps/mcb.png
                cat > AppDir/AppRun <<EOF
                #!/bin/bash
                exec \$APPDIR/usr/bin/mcb "\$@"
                EOF
                chmod +x AppDir/AppRun
                curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
                chmod +x appimagetool
                ARCH=x86_64 ./appimagetool AppDir MCB-Linux-${VERSION}-x64.AppImage || true

            - name: Upload Linux x64 artifacts
              uses: actions/upload-artifact@v4
              with:
                name: linux-release
                path: |
                  MCB-Linux-*-x64.zip
                  MCB-Linux-*-x64.deb
                  MCB-Linux-*-x64.AppImage
                retention-days: 7

            - name: Show packaged linux files
              run: |
                echo "Workspace root listing:" && ls -la || true
                echo "Matching packaged files:" && ls -la MCB-Linux-* || true

    build-linux-arm64:
        name: Build Linux (arm64)
        runs-on: ubuntu-24.04-arm
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Linux  dependencies
              run: |
                sudo apt-get update
                sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libfuse2

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Linux (arm64)
              run: flutter build linux --release

            - name: Package Linux arm64 artifacts
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                BUNDLE_DIR=build/linux/arm64/release/bundle
                # Create zip
                cd $BUNDLE_DIR && zip -r ../../../../MCB-Linux-${VERSION}-arm64.zip . && cd -
                # Create .deb package
                mkdir -p deb_pkg/DEBIAN
                mkdir -p deb_pkg/usr/bin
                mkdir -p deb_pkg/usr/share/applications
                mkdir -p deb_pkg/usr/share/mcb
                cp -r $BUNDLE_DIR/* deb_pkg/usr/share/mcb/
                cat > deb_pkg/DEBIAN/control <<EOF
                Package: mcb
                Version: ${VERSION}
                Section: utils
                Priority: optional
                Architecture: arm64
                Maintainer: lxdklp
                Description: MCB Application
                EOF
                cat > deb_pkg/usr/bin/mcb <<EOF
                #!/bin/bash
                exec /usr/share/mcb/mcb "\$@"
                EOF
                chmod +x deb_pkg/usr/bin/mcb
                cat > deb_pkg/usr/share/applications/mcb.desktop <<EOF
                [Desktop Entry]
                Name=MCB
                Exec=/usr/share/mcb/mcb
                Type=Application
                Categories=Utility;
                EOF
                dpkg-deb --build deb_pkg MCB-Linux-${VERSION}-arm64.deb
                # Create AppImage
                mkdir -p AppDir/usr/bin
                mkdir -p AppDir/usr/share/applications
                mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
                cp -r $BUNDLE_DIR/* AppDir/usr/bin/
                cat > AppDir/mcb.desktop <<EOF
                [Desktop Entry]
                Name=MCB
                Exec=mcb
                Icon=mcb
                Type=Application
                Categories=Utility;
                EOF
                cp AppDir/mcb.desktop AppDir/usr/share/applications/
                touch AppDir/usr/share/icons/hicolor/256x256/apps/mcb.png
                cat > AppDir/AppRun <<EOF
                #!/bin/bash
                exec \$APPDIR/usr/bin/mcb "\$@"
                EOF
                chmod +x AppDir/AppRun
                curl -L -o appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
                chmod +x appimagetool
                ARCH=aarch64 ./appimagetool AppDir MCB-Linux-${VERSION}-arm64.AppImage || true

            - name: Upload Linux arm64 artifacts
              uses: actions/upload-artifact@v4
              with:
                name: linux-arm64-release
                path: |
                  MCB-Linux-*-arm64.zip
                  MCB-Linux-*-arm64.deb
                  MCB-Linux-*-arm64.AppImage
                retention-days: 7

            - name: Show packaged linux-arm64 files
              run: |
                echo "Workspace root listing:" && ls -la || true
                echo "Matching packaged files:" && ls -la MCB-Linux-* || true

    build-macos:
        name: Build macOS
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build macOS
              run: flutter build macos --release

            - name: Create macOS .dmg (do not keep dSYM) and rename with version/arch
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                APP_GLOB=build/macos/Build/Products/Release/*.app
                echo "Looking for .app under: $APP_GLOB"
                APP_DIR=$(ls $APP_GLOB 2>/dev/null | head -n1 || true)
                if [ -z "$APP_DIR" ]; then
                  echo "No .app found at expected location: $APP_GLOB"
                  echo "Listing release dir contents:"
                  ls -la build/macos/Build/Products/Release || true
                  # try alternate common path
                  if [ -d build/macos/Build/Products/Release/Runner.app ]; then
                    APP_DIR=build/macos/Build/Products/Release/Runner.app
                    echo "Found Runner.app at alternative path: $APP_DIR"
                  else
                    echo "Unable to find .app to package. Failing step." >&2
                    exit 1
                  fi
                fi
                APP_NAME=$(basename "$APP_DIR" .app)
                ARCH=$(uname -m)
                OUT_NAME="MCB-macOS-${VERSION}.dmg"
                echo "Creating DMG from $APP_DIR -> ${OUT_NAME}"
                # show .app contents for debugging
                echo ".app listing:" && ls -la "$APP_DIR" || true
                if [ ! -e "$APP_DIR" ]; then
                  echo "ERROR: APP_DIR does not exist: $APP_DIR" >&2
                  exit 1
                fi
                hdiutil create -volname "$APP_NAME" -srcfolder "$APP_DIR" -ov -format UDZO "$OUT_NAME"

            - name: Upload macOS artifact
              uses: actions/upload-artifact@v4
              with:
                name: macos-release
                path: MCB-macOS-*.dmg
                retention-days: 7

    build-web:
        name: Build Web
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build Web
              run: flutter build web --release

            - name: Package Web artifact (rename with version)
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                cd build/web
                zip -r ../../MCB-Web-${VERSION}.zip .

            - name: Upload Web artifact
              uses: actions/upload-artifact@v4
              with:
                name: web-release
                path: MCB-Web-*.zip
                retention-days: 7

    build-ios:
        name: Build iOS
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                flutter-version: ${{ env.FLUTTER_VERSION }}
                channel: 'stable'
                cache: true

            - name: Install dependencies
              run: flutter pub get

            - name: Build iOS (no codesign)
              run: flutter build ios --release --no-codesign

            - name: Prepare iOS artifact (rename to .ipa)
              run: |
                set -e
                VERSION=$(grep "^version:" pubspec.yaml | head -n1 | sed 's/.*version:[[:space:]]*//; s/+.*//; s/^[[:space:]]*//; s/[[:space:]]*$//')
                # Create Payload directory structure for .ipa
                mkdir -p Payload
                cp -r build/ios/iphoneos/Runner.app Payload/
                zip -r "MCB-iOS-${VERSION}.ipa" Payload
                rm -rf Payload

            - name: Upload iOS artifact
              uses: actions/upload-artifact@v4
              with:
                name: ios-release
                path: MCB-iOS-*.ipa
                retention-days: 7

    release:
      name: Create Release
      needs: [build-android, build-windows, build-linux-x64, build-linux-arm64, build-macos, build-web, build-ios]
      runs-on: ubuntu-latest
      if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.skip_release != 'true'
      permissions:
        contents: write
      steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                path: artifacts

            - name: Collect Android APKs (no zip)
              run: |
                set -e
                mkdir -p artifacts/android-release
                # Copy any MCB-Android-<version>-*.apk files into the release folder
                cp artifacts/MCB-Android-*.apk artifacts/android-release/ 2>/dev/null || true

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                files: |
                  artifacts/android-release/*.apk
                  artifacts/ios-release/*.ipa
                  artifacts/windows-release/*.zip
                  artifacts/windows-release/*.exe
                  artifacts/linux-release/*.zip
                  artifacts/linux-release/*.deb
                  artifacts/linux-release/*.AppImage
                  artifacts/linux-arm64-release/*.zip
                  artifacts/linux-arm64-release/*.deb
                  artifacts/linux-arm64-release/*.AppImage
                  artifacts/macos-release/*.dmg
                  artifacts/web-release/*.zip
                draft: false
                prerelease: false
                generate_release_notes: true
